<%= stylesheet_link_tag "miscellaneous" %>
<%= javascript_include_tag "miscellaneous" %>
<%= stylesheet_link_tag "forms" %>
<%= javascript_include_tag "forms" %>
<%= stylesheet_link_tag "commerce" %>
<%= javascript_include_tag "commerce" %>
<%= javascript_include_tag "biomp" %>

<!-- Breadcrumb -->
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-12">
        <h2>Questions for <%= "#{@survey.name}" %></h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="<%= url_for :controller => 'survey', :action => 'overview' %>">Survey Overview</a>
            </li>
            <li class="breadcrumb-item active">
                <strong>Manage Questions</strong>
            </li>
        </ol>
        <span class="float-right">
            <!--button type="button" class="btn btn-sm btn-default" data-toggle="modal" data-target="#mobilepreview">
                <i class="fa fa-mobile"></i> Preview Mobile Survey
            </button>
            <div class="modal inmodal fade" id="mobilepreview" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title">Mobile Preview</h4>
                            </div>
                            <div class="modal-body">
                                <div id="preview" style="margin: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            <%= link_to survey_preview_path(id: @survey.id), class:"btn btn-sm btn-default", target: "_blank" do %>
                <i class="fa fa-desktop"></i> Preview Desktop Survey
            <% end %>
            <-->
        </span>
    </div>
</div>

<!-- Alerts -->
<div class="row justify-content-md-center">
    <% flash.each do |key, value| %>
        <div class="col-lg-7 alert alert-dismissable alert-<%= key == "success" || key == "notice" ? "success" : "danger" %>">
            <button aria-hidden="true" data-dismiss="alert" class="close" type="button">Ã—</button>
            <%= value %>
        </div>
    <% end %>
</div>

<div class="wrapper wrapper-content animated fadeInUp" id="loadingarea">
    <div class="sk-spinner sk-spinner-wave">
        <div class="sk-rect1"></div>
        <div class="sk-rect2"></div>
        <div class="sk-rect3"></div>
        <div class="sk-rect4"></div>
        <div class="sk-rect5"></div>
    </div>
    <div class="row justify-content-md-center">
        <!-- Manage Questions -->
        <div class="col-lg-7">
            <div class="ibox">
                <div class="ibox-content">
                    <% if !@survey.is_active? || @survey.created_today? %>
                        <div class="row">
                            <div class="col-lg-12 text-center">
                                <h3>Add questions to your survey or import existing questions from your other surveys.</h3>
                            </div>
                        </div>
                        <hr />
                        <div class="row justify-content-md-center">
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Short Answer') do %>
                                    <button type="button" class="btn btn-block btn-success">
                                        <h3><i class="fa fa-keyboard-o"></i> Short Text Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Number') do %>
                                    <button type="button" class="btn btn-block btn-mindaro">
                                        <h3><i class="fa fa-calculator"></i> Numeric Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                        </div>
                        <hr />
                        <div class="row justify-content-md-center">
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Date') do %>
                                    <button type="button" class="btn btn-block btn-eton-blue">
                                        <h3><i class="fa fa-calendar"></i> Date Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Address') do %>
                                    <button type="button" class="btn btn-block btn-bluetiful">
                                        <h3><i class="fa fa-map-marker"></i> Address Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                        </div>
                        <hr />
                        <div class="row justify-content-md-center">
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Yes/No') do %>
                                    <button type="button" class="btn btn-block btn-warning">
                                        <h3><i class="fa fa-check-square-o"></i> Yes/No Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Multiple Choice') do %>
                                    <button type="button" class="btn btn-block btn-rhythm">
                                        <h3><i class="fa fa-caret-square-o-down"></i> Drop Down Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                        </div>
                        <hr />
                        <div class="row justify-content-md-center">
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Rating') do %>
                                    <button type="button" class="btn btn-block btn-primary">
                                        <h3><i class="fa fa-sliders"></i> Rating Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                            <div class="col-lg-5">
                                <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Phone Number') do %>
                                    <button type="button" class="btn btn-block btn-silver-chalice">
                                        <h3><i class="fa fa-phone"></i> Phone Number Answer</h3>
                                    </button>
                                <% end %>
                            </div>
                        </div>
                        <hr />

                        <div class="row justify-content-md-center">
                            <div class="col-lg-5">
                              <%= link_to survey_new_question_path(survey_id: @survey.id, question_type: 'Signature') do %>
                                  <button type="button" class="btn btn-block btn-danger">
                                      <h3><i class="fa fa-pencil-square-o"></i> Signature Answer</h3>
                                  </button>
                              <% end %>
                            </div>
                        </div>

                        <hr />
                        <div class="row justify-content-md-center">
                            <div class="col-lg-8 text-center">
                                <a data-toggle="modal" class="btn btn-lg btn-default" href="#import-questions-modal"><i class="fa fa-plus-square-o"></i> Import Existing Questions </a>
                                <div class="modal inmodal fade" id="import-questions-modal" tabindex="-1" role="dialog" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                                <h4 class="modal-title">Import Existing Questions</h4>
                                                <%= form_tag survey_questions_path, id: "search-form", method: "get" do %>
                                                <div class="col-md-12">
                                                    <%= hidden_field_tag :survey_id, @survey.id %>
                                                    <div class="input-group">
                                                        <%= text_field_tag :search, params[:search] ? params[:search] : nil, class: "form-control-sm form-control", placeholder: "Search"  %>
                                                        <span>
                                                          <%= select_tag :category, options_for_select(["Short Answer", "Number", "Date", "Address", "Yes/No", "Drop Down", "Rating", "Phone Number", "Signature"]), include_blank: "All Question Types", class: "form-control-sm form-control chosen-select", required: false %>
                                                        </span>
                                                        <span class="input-group-btn">
                                                            <button id="search-btn" type="button" class="btn btn-sm btn-primary" onclick="updateSearch()" >Search</button>
                                                        </span>
                                                    </div>
                                                </div>
                                                <% end %>
                                            </div>
                                            <div id="questions-table">
                                                <%= render partial: 'import_questions' %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% else %>
                        <div class="row">
                            <div class="col-lg-12 text-center">
                                <h3>While your survey is active you will not be able to add or delete questions. If you would like to add or remove your questions please change the start date of your survey.</h3>
                            </div>
                        </div>
                        <div class="row justify-content-md-center">
                            <div class="col-lg-8 text-center">
                                <%= link_to survey_edit_path(survey_id: @survey.id), class: "btn btn-lg btn-warning" do %>
                                    <i class="fa fa-pencil"></i> Update Survey
                                <% end %>
                            </div>
                        </div>
                    <% end %>
                </div>
            </div>
            <br />
            <div class="ibox">
                <div class="ibox-content">
                    <%= form_for :question_order_object, url: "/survey/save_question_order", html: { id: "question_order_form" } do |form| %>
                        <div style="display:flex;flex-direction:row;justify-content:space-between">
                            <h3>Survey Questions</h3>
                            <button id="save-order-btn" type="submit" class="btn btn-primary btn-sm float-right"><i class="fa fa-sort-amount-asc"></i> Save Order</button>
                        </div>
                        <p><i class="fa fa-hand-o-up"></i> Drag questions between list to change order</p>
                        <ul class="sortable-list connectList agile-list" id="inprogress">
                            <% @questions.each_with_index do |question, index| %>
                                <% class_item = "" %>
                                <% if question.is_text? %>
                                    <% class_item = "success" %>
                                <% elsif question.is_yes_no? %>
                                    <% class_item = "warning" %>
                                <% elsif question.is_mc? %>
                                    <% class_item = "rhythm" %>
                                <% elsif question.is_number? %>
                                    <% class_item = "mindaro" %>
                                <% elsif question.is_date? %>
                                    <% class_item = "eton-blue" %>
                                <% elsif question.is_phone_number? %>
                                    <% class_item = "silver-chalice" %>
                                <% elsif question.is_signature? %>
                                    <% class_item = "danger" %>
                                <% elsif question.is_location? %>
                                    <% class_item = "bluetiful" %>
                                <% else %>
                                    <% class_item = "primary" %>
                                <% end %>
                                <li question-id="<%=question.id%>" id="<%=question.id%>-list-item" style="padding:0px;border:none">
                                    <div class="<%= class_item %>-element panel panel-<%= class_item %>">
                                    <div class="panel-heading question-box position-relative">
                                      <div class="display-flex-column">
                                        <i class="up fa fa-2x fa-caret-up icon-manage"></i>
                                        <i class="down fa fa-2x fa-caret-down icon-manage-down"></i>
                                      </div>
                                        <h4>&ensp;&ensp;<%= question.question_type_text %> Question
                                            <%= question.required ? "<small class='badge lg-badge badge-white';'> required</small>".html_safe : ""%>
                                        </h4>
                                    </div>
                                    <div class="panel-body">
                                        <h4><%= question.question.html_safe %></h4>
                                        <p><%= question.detail.html_safe %></p>
                                        <span class="float-right">
                                            <%= link_to survey_edit_question_path(question_id: question.id), class: "btn btn-warning btn-sm" do %>
                                                <i class="fa fa-pencil"></i> Edit
                                            <% end %>
                                            <% if !@survey.is_active? %>
                                                <%= link_to survey_question_delete_path(question_id: question.id, survey_id: @survey.id), method: "delete", class: "btn btn-danger btn-sm delete-question" do %>
                                                    <i class="fa fa-close"></i> Delete
                                                <% end %>
                                            <% end %>
                                        </span>
                                        <br />
                                    </div>
                                    </div>
                                </li>
                            <% end %>
                        </ul>
                        <% if @questions.count == 0 %>
                            <h3>There are no questions in this survey. Click one of the buttons above to create a new one!</h3>
                        <% end %>
                    <% end %>
                </div>
            </div>
        </div>

    </div>
</div>

<br />
<br />

<style>
    .ibox-content {
      display:flex;
      flex-direction:column;
    }

    .slick_demo_2 .ibox-content {
      margin: 0;
      padding: 20px;
    }

    :focus { outline: 1px solid white };
</style>

<% content_for :javascript do %>
    <script type="text/javascript">
        $('input[name="daterange"]').daterangepicker();

				$('.input-group.date').datepicker({
        	todayBtn: "linked",
        	keyboardNavigation: false,
        	forceParse: false,
        	calendarWeeks: true,
        	autoclose: true
    		});

        $('.footable').footable();

        // Add slimscroll to element
        $('.scroll_content').slimscroll({
            height: '400px'
        });

        $('#question_order_form').submit(function(eventObj) {
            var order_array = $("#inprogress").sortable( "toArray", {
                attribute: 'question-id'
            } );

            $('#question_order_form').append(`<input type="hidden" name="survey_id" value=<%= @survey.id%> /> `);
            $('#question_order_form').append(`<input type="hidden" name="question_order" value=${order_array} /> `);

            $('#loadingarea').toggleClass('sk-loading');

            return true;
        });

        function updateSearch(){
            console.log("Searching term and/or category");

            Rails.ajax({
                url: "/survey/update_import_questions",
                type: "post",
                data: `search_data=${$('#search-form').serialize()}&survey_id=${<%= @survey.id %>}&authenticity_token=${$('[name="csrf-token"]')[0].content}`,
                success: function(data) {
                    console.log(data);

                    if (data) {
                        console.log(data);
                        $('#questions-table').empty();
                        $('#questions-table').html(data['body']);
                    }
                },
                error: function(data) {
                    console.log(data);
                }
            })
        };

        $(function() {

            page_set_storage("SurveyQuestions");

            $("#todo, #inprogress, #completed").sortable({
                connectWith: ".connectList",
                update: function( event, ui ) {

                    var todo = $( "#todo" ).sortable( "toArray" );
                    var inprogress = $( "#inprogress" ).sortable( "toArray" );
                    var completed = $( "#completed" ).sortable( "toArray" );
                    $('.output').html("ToDo: " + window.JSON.stringify(todo) + "<br/>" + "In Progress: " + window.JSON.stringify(inprogress) + "<br/>" + "Completed: " + window.JSON.stringify(completed));
                }
            }).disableSelection();

            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });

            $('.slick_demo_2').slick({
                arrows: true,
                infinite: true,
                slidesToShow: 3,
                slidesToScroll: 1,
                speed: 500,
                adaptiveHeight: true,
                autoplay: true,
                autoplaySpeed: 5000,
                responsive: [
                    {
                        breakpoint: 1024,
                        settings: {
                            slidesToShow: 3,
                            slidesToScroll: 3,
                            infinite: true,
                            dots: true
                        }
                    },
                    {
                        breakpoint: 600,
                        settings: {
                            slidesToShow: 2,
                            slidesToScroll: 2
                        }
                    },
                    {
                        breakpoint: 480,
                        settings: {
                            slidesToShow: 1,
                            slidesToScroll: 1
                        }
                    }
                ]
            });

            var searchForm = document.querySelectorAll('[id=search-form]');
            var i;
            for (i = 0; i < searchForm.length; i++) {
                // Prevent Enter Event
                searchForm[i].onkeypress = function(e) {
                    var key = e.charCode || e.keyCode || 0;
                    if (key == 13) {
                        e.preventDefault();

                    }
                }
            }

            var import_button = document.getElementById('import-question');

            if (import_button) {
                import_button.addEventListener('click', function() {
                    console.log("Question Creation Started");
                    $('#loadingarea').toggleClass('sk-loading');
                });
            }

            $("#ionrange_2").ionRangeSlider({
                min: 0,
                max: 10,
                type: 'single',
                step: 1,
                postfix: " Rating Title",
                prettify: false,
                hasGrid: false,
                disable: true
						});


				});

        $("#clearbutton").click(function() {
            console.log("Clear Tags");
            $('.tagsinput').tagsinput('removeAll');
        });

        function handleFiles(files) {
          // Check for the various File API support.
          if (window.FileReader) {
              // FileReader are supported.
              getAsText(files[0]);
          } else {
              alert('FileReader are not supported in this browser.');
          }
        }

        function getAsText(fileToRead) {
          var reader = new FileReader();
          // Read file into memory as UTF-8
          reader.readAsText(fileToRead);
          // Handle errors load
          reader.onload = loadHandler;
          reader.onerror = errorHandler;
        }

        function loadHandler(event) {
          var csv = event.target.result;
          processData(csv);
        }

        function processData(csv) {
            var allTextLines = csv.split(/\r\n|\n/);
            var lines = [];
            for (var i=0; i<allTextLines.length; i++) {
                var data = allTextLines[i].split(',');
                    var tarr = [];
                    for (var j=0; j<data.length; j++) {
                        $('.tagsinput').tagsinput('add', data[j]);
                        tarr.push(data[j]);
                    }
                    lines.push(tarr);
            }
            console.log(lines);
        }

        function errorHandler(evt) {
          if(evt.target.error.name == "NotReadableError") {
              alert("Canno't read file !");
          }
        }

    </script>
<% end %>
